---
title: "SIBER_explorations"
author: "Ana Miller-ter Kuile"
date: "11/11/2020"
output: 
  html_document:
    toc: true
    toc_float:
      collapsed: false
    toc_depth: 2
    df_print: paged
    theme: readable
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load packages

```{r}
package.list <- c("here", "tidyverse", 
                  "SIBER", "glmmTMB",
                  "MuMIn", "emmeans",
                  "ggeffects", "DHARMa",
                  "effects",
                  "vegan", "remotes",
                  "eulerr", "dummies",
                  "rKIN")

## Installing them if they aren't already on the computer
new.packages <- package.list[!(package.list %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)

## And loading them
for(i in package.list){library(i, character.only = T)}
```

# Load data

Load data, which includes cane spider isotope data, plant isotope data (for correcting), cane spider body size data, and island attributes

```{r}
spider_iso <- read.csv(here("data", "isotopes", "2009-2015_Cane Spider Isotopes.csv"))

plant_iso <- read.csv(here("data", "isotopes", "2009-2012 Palmyra Plant Isotope Data.csv"))

spider_size <- read.csv(here("data", "size", "Spider sizes 2009-2015.csv"))

islands <- read.csv(here('data', "Island_data.csv"))
```

# Roadmap {#roadmap}

1. Correct raw $\delta^{15}N$ values with plant $\delta^{15}N$

2. Calculate SIBER objects *per island*, including:

  + $\delta^{15}N$ range (**NR**): larger NR, larger trophic diversity within the population
  
  + $\delta^{13}C$ range (**CR**): larger CR, more resource pools, so more niche diversification among individuals
  
  + Total area (**TA**): niche space occupied by population 
  
  + Mean distance to centroid (**CD**): a measure of how similar individuals are to each other that is more invariant to outliers than TA
  
  + Nearest neighbor distance (**NND**): another representation of how similar individuals are to each other in trophic space, or how similar their niches are
  
  + Standard deviation in nearest neighbor distance (**SDNND**): less influenced by sample size than NND, gives a metric of how similar individual niches are to each other

3. Pre-statistics data visualizations

4. Statistical analyses (resource use could be any or all measures above of trophic diversity and niche space or raw values for nitrogen or carbon isotopes):

  + 1. What is the effect of island productivity on resource use? 
  
  + 2. What is the effect of island size on resource use? 
  
  + 3. Is there a relationship between individual body size and resource use? 

# $\delta^{15}N$ correction

```{r}
str(spider_iso)
```
Need to split ID column into island and ID columns

```{r}
spider_iso <- spider_iso %>%
  separate(ID, 
           into = c("Island", "ID"), 
           sep = " "
           )
```

Make sure that island names in spider_iso and plant_iso match

```{r}
unique(spider_iso$Island)
```
```{r}
unique(plant_iso$Island.name)
```

A few of the `spider_iso` island names need to be changed to match those in the `plant_iso` dataframe. I'll do this with an `ifelse` statement in the mutate function in dplyr, which says "Remake this variable `Island` such that if `Island` = "Para", change it to "Paradise", otherwise keep the current value in the column for `Island`". And on and on for each island that needs renaming, including
East - Eastern
NF - N. Fighter
SF - S. Fighter
Whip - Whipoorwill
Para - Paradise

```{r}
spider_iso <- spider_iso %>%
  mutate(Island = case_when(Island == "Para" ~ "Paradise",
                            Island == "East" ~ "Eastern",
                            Island == "NF" ~ "N.Fighter",
                            Island == "SF" ~ "S.Figher",
                            Island == "Whip" ~ "Whipoorwill",
                            TRUE ~ Island))

plant_iso <- plant_iso %>%
  mutate(Island = case_when(Island.name == "N. Fighter" ~ "N.Fighter",
                            Island.name == "S. Fighter" ~ "S.Figher",
                            Island.name == "NS Causeway" ~ "NSCauseway",
                            TRUE ~ Island.name))
```

```{r}
unique(spider_iso$Island)
```

There are multiple ways to do this next step, but what I'm going to do is 1) average all the plant $\delta^{15}N$ values per island giving it the name `plant_d15N`, and then 2) join that dataframe to the spider dataframe. Last, 3) I can just create a new column with the `mutate()` function that is the corrected $\delta^{15}N$ of animal $\delta^{15}N$ - plant $\delta^{15}N$. 

### 1. Average plant values

```{r}
plant_iso <- plant_iso %>%
  group_by(Island.name) %>%
  summarise(plant_d15N = mean(d15N))
```
### 2. Join plant and spider isotope dataframes

```{r}
spider_iso <- spider_iso %>%
  dplyr::select(Island, ID, d15N, d13C, Year) %>%
  left_join(plant_iso, by = c("Island" = "Island.name"))
```

### 3. (could do as part of 2. above) add new corrected d15N column

```{r}
spider_iso <- spider_iso %>%
  mutate(d15N_c = d15N - plant_d15N)
```

Remove the one island with only one value and the island with no plant data.

```{r}
spider_iso <- spider_iso %>%
  filter(Island != "Ainsley") %>%
  filter(!is.na(plant_d15N))
```


# Calculate per-island SIBER objects

(from Layman et al. 2007). the `laymanMetrics()` function in `SIBER` calculates the following metrics (explained in ecological context in the [roadmap](#roadmap)): 

  + $\delta^{15}N$ range (**NR**): trophic diversity (higher = greater diversity)
  
  + $\delta^{13}C$ range (**CR**): resource pool use (higher = broader resource use)
  
  + Total area (**TA**): niche of community (bigger = bigger niche)
  
  + Mean distance to centroid (**CD**): similar to TA, but less influenced by outliers (bigger = bigger niche)
  
  + Nearest neighbor distance (**NND**): trophic similarity (bigger = more individual variation)
  
  + Standard deviation in nearest neighbor distance (**SDNND**): similar to NND but less influenced by sample size (bigger = more individual variation)
  
Annoyingly, the standard `SIBER` functions are automatically programmed to take data in a particular format (different species within communities), which is not what we are trying to accomplish here. We are trying to understand relationships between individuals in a population. So - I'm going to use the `laymanMetrics()` function to manually calculate all of these values for each community ("Island"). Then we can use these in analyses. The `laymanMetrics()` function asks for two vectors of values which correspond to the two isotope values per individual. What I'm going to do is 1) split the dataframe for isotopes into a dataframe per island, 2) build a function that will compute the layman metrics for each of these split dataframes, and 3) combine those all back into one dataframe so we can compare them. 

### 1. split dataframe for isotopes into by-island/year dataframe

```{r}
island_isos <- split(spider_iso, paste(spider_iso$Island,spider_iso$Year))
```

### 2. Function to compute layman metrics for each dataframe by island

```{r}
population_metrics <- function(df) {
  x <- df$d13C
  y <- df$d15N_c
  layman <- laymanMetrics(x, y)
  metrics <- as.data.frame(layman$metrics)
  
  metrics <- metrics %>%
    rownames_to_column(var= "metric") %>%
    rename("value" = "layman$metrics")

  return(metrics)

}
```

### 3. run that function, and then combine into one dataframe

```{r}
island_layman_metrics <- lapply(island_isos, FUN = population_metrics)

island_metrics <- dplyr::bind_rows(island_layman_metrics, .id = "island_layman_metrics")
```

Let's attach our island level metadata on size and productivity to this so we will be ready to do analyses! First we'll rename this column in the metrics dataframe and make sure the naming conventions match between this dataframe and that of the enviornmental data.

```{r}
island_metrics <- island_metrics %>%
  rename("Island" = "island_layman_metrics") %>%
  separate(Island, 
           into = c("Island", "Year"), 
           sep = -4) %>%
  separate(Island, #removes space created by last call
           into = c("Island", "blank"),
           sep = -1) %>%
  dplyr::select(-blank)
           

unique(island_metrics$Island)
```

```{r}
unique(islands$Island)
```


need to rename just a couple, North Fighter - N. Fighter, South Fighter - S. Fighter

```{r}
islands <- islands %>%
  mutate(Island = case_when(Island == "Home NE" ~ "HomeNE",
                            Island == "Home SW" ~ "HomeSW",
                            Island == "North Fighter" ~ "N.Fighter",
                            Island == "NS Causeway" ~ "NSCauseway",
                            Island == "South Fighter" ~ "S.Fighter",
                            TRUE ~ Island))
```

```{r}
unique(islands$Island)
```

Looks good! So we can combine these. And add some categorical values for productivity and size while we're at it. The `ifelse()` statements below are saying, look at the values for `Island_prod` and `Island_Area`, if this value is above a certain threshold, this is a "high productivity" and/or "big" island, otherwise it is a "low productivity" or "small" island. I'm also going to mutate the order of the `metric` variable so we can look at the graph below in the order we've been talking about these variables.

```{r}
island_metrics <- island_metrics %>%
  left_join(islands, by = "Island") %>%
  mutate(prod_level = ifelse(Island_prod > 0.008707850, "high", "low"),
         size_level = ifelse(Island_Area > 39629.5965, "big", "small")) %>%
  mutate(metric = ifelse(metric == "dX_range", "dC_range",
                         ifelse(metric == "dY_range", "dN_range",
                                metric))) %>%
  mutate(metric = factor(metric, levels = c("dC_range", "dN_range", "TA", "CD",
                                            "NND", "SDNND"))) %>%
  filter(Island != "Ainsley") #only one sample for Ainsley 2009
```

These data aren't "tidy" for analyses right now, but they are set up nicely for a quick visualization based on island environmental variables.


# Pre-statistics data visualizations

  + 1. How does resource availability influence trophic position?
  
  + 2. How does resource availability influence isotopic niche?
  
  + 3. Does resource availability enable consumers to reach a larger body size, thus providing a mechanism for shifts in trophic position or isotopic niche?
  
  + 4. Do consumers in environments with different resource availabilities eat distinct prey communities, and do these prey have different relative trophic positions?
  
Questions 1. & 2. above are best asked with the same model (e.g. including both factors and seeing whether they're important). However, this question encompasses many different values, including:

  + 1. Raw $\delta^{13}C$ values: if the absolute value of these is different, it means that predators are getting resources from different places on different islands. In this case, that would be either more marine or more terrestrial. Higher values (closer to 0) correspond to more marine, lower values (more negative) correspond to more terrestrial resources.

  + 2. Raw $\delta^{15}N$ values: if the absolute value of these is different, similar to Young et al. 2013, this indicates that island environmental context shapes maximum food chain length (e.g. whether predators eat herbivores or other predators)

  + 3. dC_range: the larger this range, the more niche variation there is across the population, meaning that larger values mean the population is taking advantage of multiple resource pools. 

  + 4. dN_range: the larger the range, the more trophic diversity there is in that population, meaning this population is not feeding on *just* herbivores or *just* predators, but rather can have the pick of the bunch of resources in the environment.

  + 5. TA and CD: how broad in both C and N space is the "niche" of the species. Are these numbers small, indicating that the population is feeding in a pretty specific set of resources, or is this a larger number, indicating that individuals are feeding on a lot of disparate resources?

  + 6. NND and SDNND: how similar are individuals to each other in a population - again, is this value small, indicating that individuals are eating some smaller, similar resource pool, or are these values larger, indicating that this population is relying on a really broad range of resources?
  
### Raw isotope explorations
  
```{r}
spider_iso <- spider_iso %>%
  left_join(islands, by = "Island") %>%
  mutate(prod_level = ifelse(Island_prod > 0.008707850, "high", "low"),
         size_level = ifelse(Island_Area > 39629.5965, "big", "small")) 

spider_iso %>%
  mutate(Island = factor(Island, 
                         levels = c("Castor", "Fern", "Holei",
                                    "Kaula", "Paradise", "Dudley",
                                    "Eastern", "Leslie", "Lost", "Sand"))) %>%
  filter(!is.na(prod_level)) %>%
  filter(Year != 2009) %>%
ggplot(aes(x = d13C, y = d15N_c, level = prod_level)) +
  geom_point(aes(shape = prod_level, color = Island), size = 3) +
  stat_ellipse(size = 1) +
  stat_ellipse(aes(color = Island), linetype = "dashed", size = 1) +
  scale_color_manual(values = c("#543005", "#8c510a", "#bf812d",
                                "#dfc27d", "#f6e8c3", "#c7eae5",
                                "#80cdc1", "#35978f", "#01665e", "#003c30")) +
  theme_bw() 
```
Values higher on the y in this graph are higher trophic levels (e.g. eating predators vs. herbivores), values farther to the right on the x-axis correspond to more marine resources, more to the right are more terrestrial. It definitely looks like there are some island productivity patterns in bi-plot space!

These same patterns in isotope bi-plot space don't seem to be happening with islet size.

```{r}
spider_iso %>%
  mutate(rats = ifelse(Year == 2009, "present", "absent")) %>%
  mutate(rats = factor(rats, levels = c("present", "absent"))) %>%
ggplot(aes(x = d13C, y = d15N_c, level = size_level)) +
  geom_point(aes(shape = size_level)) +
  stat_ellipse() +
  stat_ellipse(aes(color = Island), linetype = "dashed") +
  theme_bw() +
  facet_wrap(~rats)
```

```{r}
spider_iso %>%
  filter(!is.na(prod_level)) %>%
ggplot(aes(x = d13C, y = d15N_c, level = prod_level)) +
  geom_point(aes(shape = prod_level)) +
  stat_ellipse() +
  stat_ellipse(aes(color = Island), linetype = "dashed") +
  theme_bw() +
  facet_wrap(~size_level)
```
```{r}
spider_iso %>%
  filter(!is.na(prod_level)) %>%
  filter(Year != 2009) %>%
ggplot(aes(x = d13C, y = d15N_c, level = prod_level)) +
  geom_point(aes(shape = prod_level)) +
  stat_ellipse() +
  stat_ellipse(aes(color = Island), linetype = "dashed") +
  theme_bw() 

spider_iso %>%
  filter(!is.na(prod_level)) %>%
  filter(Year != 2009) %>%
  group_by(prod_level, Island, Year) %>%
  tally()
```

```{r}
spider_iso %>%
  filter(!is.na(prod_level)) %>%
  filter(Year != 2009) %>%
ggplot(aes(x = d13C, y = d15N_c, level = size_level)) +
  geom_point(aes(shape = size_level)) +
  stat_ellipse() +
  stat_ellipse(aes(color = Island), linetype = "dashed") +
  theme_bw() 
```

```{r}
spider_iso %>%
  filter(!is.na(prod_level)) %>%
ggplot(aes(x = prod_level, y = d15N_c, fill = size_level)) +
  geom_boxplot() +
  theme_bw()
```
Not at all surprisingly, on high productivity islands, spiders are eating at higher trophic levels, which is what we knew from Young et al. 2013. Also there seems to be a big-small island effect in this graph, where within productivity levels, spiders on smaller islands have lower trophic levels, so I'll be curious if that remains important.

```{r}
spider_iso %>%
  filter(!is.na(prod_level)) %>%
  ggplot(aes(x = prod_level, y = d13C, fill = size_level)) +
  geom_boxplot() +
  theme_bw()
```

In this graph, a value higher on the y corresponds to more marine. There aren't really any clear patterns here. 

### Community metric explorations

These are the same graphs as above, but as a refresher here. 

Island productivity: 

```{r}
island_metrics %>%
  filter(!is.na(prod_level)) %>% #remove NA value
  filter(Year != 2009) %>%
  filter(!metric %in% c("TA", "NND")) %>%
ggplot(aes(x = prod_level, y = value, fill = size_level)) +
  geom_boxplot() +
  facet_wrap(~metric, scales = "free") +
  theme_bw() 
```

### Body size explorations

Question 3. above would be best addressed with thinking about how body size is related to d15N, d13C or both combined. 

do larger spiders have higher d15N?, do larger spiders feed on different resource pools (different d13C)?

Excitingly for this dataset, there doesn't seem to be a relationship between island size or productivity with spider size. So any answers we get won't be confused by just island-level differences, which is cool. Also interesting to see these isotope differences among a population that is really similar in body size (IMO)!

```{r}
unique(spider_size$Island)
```

```{r}
spider_size <- spider_size %>%
  mutate(Island = case_when(Island == "North Fighter" ~ "N.Fighter",
                            Island == "South Fighter" ~ "S.Fighter",
                            Island == "NS Causeway" ~ "NSCauseway",
                            Island == "Home NE" ~ "HomeNE",
                            Island == "Home SW" ~ "HomeSW",
                            Island == "Strawn " ~ "Strawn",
                            TRUE ~ Island))
```

```{r}
unique(spider_size$Island)
```


```{r}
spider_size2 <- spider_size %>%
  filter(Year %in% c(2015, 2009, 2012)) %>%
  dplyr::select(Island, ID, Length_mm, Mass_g, Year) %>%
  separate(ID, 
           into = c("Island_2", "ID_2"), 
           sep = -2,
           remove = F) %>%
  mutate(ID_2 = str_squish(ID_2)) %>%
  dplyr::select(-ID, -Island_2) %>%
  rename("ID" = "ID_2")

```


combine with isotope data

```{r}
spider_size_iso <- spider_iso %>%
  left_join(spider_size2, by = c("Island", "ID", "Year"))
```

```{r}
spider_size_iso %>%
  filter(!is.na(prod_level)) %>%
ggplot(aes(x = prod_level, y = Mass_g, fill = size_level)) +
  geom_boxplot() +
  theme_bw()
```

Also there don't seem to be really strong relationships between mass and isotope values

```{r}
ggplot(spider_size_iso, aes(x = Mass_g, y = d15N_c)) +
  geom_point() +
  geom_smooth(method = "lm", se =F) +
  theme_bw()
```

```{r}
ggplot(spider_size_iso, aes(x = Mass_g, y = d13C)) +
  geom_point() +
  geom_smooth(method = "lm", se =F) +
  theme_bw()
```

Or in bi-plot space

```{r}
ggplot(spider_size_iso, aes(x = d13C, y = d15N_c, size = Mass_g)) +
  geom_point() +
  theme_bw()
```
The differences across islands don't seem to be driven by body size differences, which I think is super interesting! Instead, they are similar populations using different environments differently!

```{r}
ggplot(spider_size_iso, aes(x = Island_prod, y = Mass_g)) +
  geom_point() +
  theme_bw()
```

```{r}
ggplot(spider_size_iso, aes(x = Island_Area, y = Mass_g)) +
  geom_point() +
  theme_bw()
```

```{r}
ggplot(spider_size_iso, aes(x = prod_level, y = Mass_g)) +
  geom_boxplot() +
  theme_bw() +
  scale_y_log10()
```

```{r}
ggplot(spider_size_iso, aes(x = size_level, y = Mass_g)) +
  geom_boxplot() +
  theme_bw() +
  scale_y_log10()
```

```{r}
spider_size_iso %>%
  group_by(prod_level) %>%
  summarise(n())
```

```{r}
spider_size_iso %>%
  group_by(size_level) %>%
  summarise(n())
```




```{r}
hist(spider_size_iso$Mass_g)
```

# DNA isotope explorations

CCA of
How does island, productivity, island size, predator body size, or $\delta^{15}N$ or $\delta^{13}C$ shape prey community composition. I'll be using the data I'm building for my dissertation chapter for this analysis. 

```{r}
DNA <- read.csv(here("data", 
                     "DNA", 
                     "all_prey_DNA.csv"))

DNA_meta <- read.csv(here("data",
                          "DNA",
                          "Sample_metadata.csv"))
```

What I want to do is subset the DNA data for the data only from those samples I have isotopes from. This also requires merging the IDs from the isotope data with the IDs from DNA extraction.

Clean up the DNA interaction dataframe.

```{r}
DNA <- DNA %>%
  filter(sample_str == "HEV") %>%
  filter(Order != "Primates") %>%
  filter(ID_level %in% c("Order", "Family", "Genus", "Species")) %>%
  filter(reads > 0) %>%
  dplyr::select(sample, 
                Class, 
                Order,
                reads) %>%
    mutate(sample = str_sub(sample,1,nchar(sample)-1)) %>%
    mutate(presence = 1)

```

```{r}
DNA_meta <- DNA_meta %>%
  filter(ID == "Heteropoda venatoria") %>% #& Year == 2015) %>%
  mutate(Isotope_ID = word(Isotope_ID,2)) %>%
  dplyr::select(Island, Isotope_ID, Extraction.ID) %>%
  distinct(Island, Isotope_ID, Extraction.ID) 
```

Add the extraction ID to the spider isotope dataframe

```{r}
spider_iso15 <- spider_iso %>%
  #filter(Year == 2015) %>%
  full_join(DNA_meta, by = c("Island", c("ID" = "Isotope_ID")))

DNA_iso <- spider_iso15 %>%
  filter(!is.na(Extraction.ID)) %>%
  dplyr::select(-d15N, -plant_d15N) %>%
  left_join(DNA, by = c("Extraction.ID" = "sample"))
```


```{r}
#matrix for CCA with diet as columns, samples as rows
DNA_mat <- DNA_iso %>%
  filter(!is.na(Order)) %>%
  filter(!Island %in% c("Cooper", "North Fighter")) %>%
  dplyr::select(Extraction.ID, Order, presence) %>%
  ungroup() %>%
  distinct(Extraction.ID, Order, presence) %>%
  filter(Extraction.ID != "HEV74") %>%
  pivot_wider(names_from = Order,
              values_from = presence,
              values_fill = 0) %>%
  column_to_rownames(var = "Extraction.ID")

#metadata for CCA
DNA_iso_meta <- DNA_iso %>%
  filter(!is.na(Order)) %>%
  filter(!Island %in% c("Cooper", "North Fighter")) %>%
  mutate(prod_level = case_when(Island %in% c("Sand", "Leslie") ~ "high",
                                Island == "Holei" ~ "low",
                                TRUE ~ prod_level)) %>%
  mutate(size_level = case_when(Island %in% c("Holei", "Sand") ~ "big",
                                Island == "Leslie" ~ "small",
                                TRUE ~ size_level)) %>%
  dplyr::select(Extraction.ID,
                prod_level,
                size_level,
                Island) %>%
  filter(Extraction.ID != "HEV74") %>%
  distinct(Extraction.ID,
           prod_level,
           size_level,
           Island) %>%
  column_to_rownames(var = "Extraction.ID")

#check that rownames are the same:
all.equal(rownames(DNA_mat), rownames(DNA_iso_meta))

```

CCA of diet by predictors from environment and predator

```{r}
#working off this tutorial
#http://dmcglinn.github.io/quant_methods/lessons/multivariate_models.html
# vegan requires that we write out each term if we are not going to 
# convert the factor to a dummy matrix 
# alternatively we could use a shorthand approach
cca_dna <-  cca(DNA_mat ~ . , data=DNA_iso_meta)

#view the CCA loadings
cca_dna
summary(cca_dna)
#how much variation explained in this RDA
RsquareAdj(cca_dna)
#ANOVA of whole model
anova(cca_dna, permutations=10000)
#ANOVA of model terms
anova(cca_dna, by='margin', permutations=10000)

plot(cca_dna, scaling=1, display=c('sp', 'lc', 'cn'), main='Triplot CCA matrix ~ env -scaling 1')

plot(cca_dna, display=c('sp', 'lc', 'cn'), main="Triplot CCA matrix ~ env -scaling 2")
```

```{r}
#pretty ggplot plot 
islands_dna <- DNA_iso %>%
  dplyr::select(Island, Extraction.ID) %>%
  distinct(Extraction.ID, Island)
#site metadata
sites <- DNA_iso_meta %>%
  rownames_to_column("site") #%>%
  #left_join(islands_dna, by = c("site" = "Extraction.ID"))
#get the site (sample) scores out and attach to site metadata
CCAscores <- scores(cca_dna, display = "sites") %>% 
  as.data.frame() %>% 
  rownames_to_column("site") %>%
  left_join(sites, by = "site")

#get vector out representing the loading by both isotopes
CCAvect <- scores(cca_dna, display = "bp") %>% 
  as.data.frame() %>%
  rownames_to_column(var = "ID") 

ggplot() +
  geom_vline(xintercept = c(0), color = "grey70", linetype = 2) +
  geom_hline(yintercept = c(0), color = "grey70", linetype = 2) +
  geom_point(data = CCAscores, aes(x = CCA1, y = CCA2, color = Island), size = 3) +
  geom_segment(data = CCAvect, 
               aes(x = 0, y = 0, xend = CCA1, yend = CCA2), 
               arrow = arrow(length = unit(0.2, "cm")),
               size = 1) +
  geom_text(data = CCAvect, aes(x = CCA1, y = CCA2, label = ID), 
            nudge_y = -0.3, size = 5) +
  theme_bw() +
  labs(x = "CCA1",
       y = "CCA2") +
  theme(axis.text = element_text(size = 20),
        axis.title = element_text(size = 25))

```




```{r}
DNA_iso %>%
  filter(!is.na(Order)) %>%
  filter(!Island %in% c("Cooper", "North Fighter")) %>%
  group_by(Island, Order) %>%
  summarise(frequency = n()) %>%
 mutate(Island = factor(Island, levels = c("Fern", "Holei", "Leslie", "Sand", "Eastern"))) %>%
ggplot(aes(x = Island, y = frequency, fill = Order)) +
  geom_bar(stat="identity", position = "fill") +
  theme_bw()
```

```{r}
DNA_iso %>%
  filter(!Island %in% c("Cooper", "North Fighter")) %>%
  filter(!is.na(Order)) %>%
  mutate(prod_level = case_when(Island %in% c("Sand", "Leslie") ~ "high",
                                Island == "Holei" ~ "low",
                                TRUE ~ prod_level)) %>%
  group_by(prod_level, Order) %>%
  summarise(frequency = n()) %>%
  #mutate(Order = factor(Order, levels = c("Araneae",
  #                                        "Geophilomorpha",
  #                                        "Odonata", 
  #                                        "Sarcoptiformes",
  #                                        "Blattodea",
  #                                        "Dermaptera",
  #                                        "Diptera",
  #                                        "Hymenoptera",
  #                                        "Orthoptera",
  #                                        "Hemiptera",
  #                                        "Lepidoptera"))) %>%
ggplot(aes(x = prod_level, y = frequency, fill = Order)) +
  geom_bar(stat="identity", position = "fill") +
  theme_bw()
```

```{r}
DNA_iso %>%
  filter(!is.na(Order)) %>%
  group_by(size_level, Order) %>%
  summarise(frequency = n()) %>%
  mutate(Order = factor(Order, levels = c("Araneae",
                                          "Geophilomorpha",
                                          "Odonata", 
                                          "Sarcoptiformes",
                                          "Blattodea",
                                          "Dermaptera",
                                          "Diptera",
                                          "Hymenoptera",
                                          "Orthoptera",
                                          "Hemiptera",
                                          "Lepidoptera"))) %>%
ggplot(aes(x = size_level, y = frequency, fill = Order)) +
  geom_bar(stat="identity", position = "fill") +
  theme_bw()
```


```{r}
trophics <- DNA_iso %>%
  filter(!Island %in% c("Cooper", "North Fighter")) %>%
  filter(!is.na(Order)) %>%
  mutate(tp = case_when(Order %in% c("Sarcoptiformes",
                                     "Araneae",
                                     "Geophilomorpha",
                                     "Odonata",
                                     "Scorpiones") ~ "predators",
                        Order %in% c("Orthoptera",
                                     "Dermaptera",
                                     "Hymenoptera") ~ "omnivores",
                        Order %in% c("Blattodea", 
                                     "Diptera",
                                     "Hemiptera",
                                     "Lepidoptera",
                                     "Psocoptera") ~ "primary consumers"
                        ))


trophics %>%
  group_by(Island, tp) %>%
  summarise(frequency = n()) %>%
  mutate(Island = factor(Island, levels = c("Fern", "Holei", "Leslie", "Sand", "Eastern"))) %>%
ggplot(aes(x = Island, y = frequency, fill = tp)) +
  geom_bar(stat="identity", position = "fill") +
  theme_bw()
```


```{r}
trophics %>%
  group_by(prod_level, tp) %>%
  mutate(prod_level = case_when(Island %in% c("Sand", "Leslie") ~ "high",
                                Island == "Holei" ~ "low",
                                TRUE ~ prod_level)) %>%
  summarise(frequency = n()) %>%
ggplot(aes(x = prod_level, y = frequency, fill = tp)) +
  geom_bar(stat="identity", position = "fill") +
  theme_bw()
```








